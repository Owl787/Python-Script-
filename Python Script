import discord
from discord.ext import commands
import asyncio
from collections import defaultdict

TOKEN = "YOUR_ACCOUNT_TOKEN"
TARGET_CHANNEL_ID = 123456789012345678  # <-- change to your target channel ID
CONTROL_CHANNEL_ID = 987654321098765432  # <-- change to your control channel ID

intents = discord.Intents.all()
bot = commands.Bot(command_prefix="!", self_bot=True, intents=intents)

# Tracks reactions: {message_id: {user_id: emoji}}
message_reactions = defaultdict(dict)

@bot.event
async def on_ready():
    print(f"Logged in as {bot.user}")

@bot.event
async def on_reaction_add(reaction, user):
    if user.id == bot.user.id:
        return

    msg = reaction.message
    if msg.channel.id == TARGET_CHANNEL_ID:
        message_reactions[msg.id][user.id] = str(reaction.emoji)

@bot.command()
async def check(ctx, message_id: int):
    """Trigger manually from control channel."""
    if ctx.channel.id != CONTROL_CHANNEL_ID:
        return

    try:
        target_channel = bot.get_channel(TARGET_CHANNEL_ID)
        message = await target_channel.fetch_message(message_id)

        users_handled = set()

        for reaction in message.reactions:
            async for user in reaction.users():
                if user.id == bot.user.id:
                    continue

                if user.id not in users_handled:
                    sent = await ctx.send(f"#P {user.id}")
                    await sent.add_reaction("❌")
                    users_handled.add(user.id)
                    await asyncio.sleep(0.5)

                # Also send P for the author if different
                if message.author.id != user.id and message.author.id not in users_handled:
                    sent = await ctx.send(f"#P {message.author.id}")
                    await sent.add_reaction("❌")
                    users_handled.add(message.author.id)
                    await asyncio.sleep(0.5)

        # Store for reaction removal later
        message_reactions[message.id] = {
            user.id: str(reaction.emoji)
            async for reaction in message.reactions
            for user in await reaction.users().flatten()
            if user.id != bot.user.id
        }

    except Exception as e:
        await ctx.send(f"Error: {e}")

@bot.event
async def on_raw_reaction_add(payload):
    """Handle ❌ reaction to #P commands in control channel."""
    if payload.user_id != bot.user.id:
        return
    if str(payload.emoji.name) != "❌":
        return

    channel = bot.get_channel(payload.channel_id)
    if channel.id != CONTROL_CHANNEL_ID:
        return

    try:
        msg = await channel.fetch_message(payload.message_id)
        if not msg.content.startswith("#P "):
            return

        user_id = int(msg.content.split()[1])

        for message_id, reacts in message_reactions.items():
            if user_id in reacts:
                emoji = reacts[user_id]
                target_channel = bot.get_channel(TARGET_CHANNEL_ID)
                target_msg = await target_channel.fetch_message(message_id)
                await target_msg.remove_reaction(emoji, discord.Object(id=user_id))
                print(f"Removed {emoji} from user {user_id} on message {message_id}")
                del reacts[user_id]
                break

    except Exception as e:
        print(f"Failed to remove reaction: {e}")
